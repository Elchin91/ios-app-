name: Build iOS IPA (Simple)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build IPA with EAS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Clear EAS cache
        run: |
          echo "Clearing EAS cache..."
          rm -rf ~/.expo || true
          rm -rf .expo || true
        continue-on-error: true

      - name: Initialize EAS project
        run: |
          echo "Initializing EAS project..."
          eas init --id $(uuidgen) --non-interactive || echo "Project may already be initialized"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        continue-on-error: true

      - name: Build IPA (with retry)
        id: build
        run: |
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES"
            if eas build --platform ios --profile trollstore --non-interactive --no-wait; then
              echo "Build started successfully"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Build failed, waiting 30 seconds before retry..."
                sleep 30
              else
                echo "Build failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Wait for build and get URL
        id: build-url
        run: |
          echo "Waiting for build to complete..."
          sleep 10
          
          MAX_WAIT=1800
          WAIT_TIME=0
          INTERVAL=30
          
          while [ $WAIT_TIME -lt $MAX_WAIT ]; do
            BUILD_STATUS=$(eas build:list --platform ios --limit 1 --json 2>/dev/null | jq -r '.[0].status // "unknown"')
            
            if [ "$BUILD_STATUS" = "finished" ]; then
              BUILD_URL=$(eas build:list --platform ios --limit 1 --json | jq -r '.[0].artifacts.buildUrl // .[0].artifacts.url // .[0].url')
              BUILD_ID=$(eas build:list --platform ios --limit 1 --json | jq -r '.[0].id')
              
              echo "BUILD_URL=$BUILD_URL" >> $GITHUB_OUTPUT
              echo "BUILD_ID=$BUILD_ID" >> $GITHUB_OUTPUT
              echo "✅ Build completed! IPA файл доступен по ссылке: $BUILD_URL"
              echo "Build ID: $BUILD_ID"
              exit 0
            elif [ "$BUILD_STATUS" = "errored" ] || [ "$BUILD_STATUS" = "canceled" ]; then
              echo "❌ Build failed with status: $BUILD_STATUS"
              exit 1
            else
              echo "Build status: $BUILD_STATUS, waiting $INTERVAL seconds..."
              sleep $INTERVAL
              WAIT_TIME=$((WAIT_TIME + INTERVAL))
            fi
          done
          
          echo "⏱️ Build timeout after $MAX_WAIT seconds"
          BUILD_ID=$(eas build:list --platform ios --limit 1 --json | jq -r '.[0].id // "unknown"')
          BUILD_URL="https://expo.dev/accounts/[your-account]/builds/$BUILD_ID"
          echo "Check build status manually: $BUILD_URL"
          echo "BUILD_URL=$BUILD_URL" >> $GITHUB_OUTPUT
          exit 1
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Comment PR with build URL
        if: github.event_name == 'pull_request' && steps.build-url.outputs.BUILD_URL != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ IPA файл собран! Скачайте его здесь: ${{ steps.build-url.outputs.BUILD_URL }}`
            })

