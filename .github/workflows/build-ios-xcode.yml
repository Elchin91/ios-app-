name: Build iOS IPA with Xcode

on:
  workflow_dispatch:

jobs:
  build:
    name: Build IPA with Xcode
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Prebuild iOS project
        run: |
          npx expo prebuild --platform ios --clean || \
          (echo "‚ö†Ô∏è Prebuild failed, trying without clean..." && npx expo prebuild --platform ios)

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install
          cd ..

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'

      - name: List available SDKs
        run: |
          echo "=== Available SDKs ==="
          xcodebuild -showsdks
          echo ""
          echo "=== Available Schemes ==="
          xcodebuild -list -workspace ios/M10Wallet.xcworkspace || xcodebuild -list -project ios/M10Wallet.xcodeproj

      - name: Build iOS App
        run: |
          mkdir -p ${{ github.workspace }}/build
          
          # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—É—é –≤–µ—Ä—Å–∏—é iOS SDK
          echo "üîç –ò—â–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ SDK..."
          xcodebuild -showsdks
          IOS_SDK=$(xcodebuild -showsdks | grep -o 'iphoneos[0-9.]*' | head -n 1 | sed 's/iphoneos//' || echo "")
          
          if [ -z "$IOS_SDK" ]; then
            echo "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –≤–µ—Ä—Å–∏—è SDK, –∏—Å–ø–æ–ª—å–∑—É–µ–º iphoneos"
            SDK_ARG="-sdk iphoneos"
          else
            echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º SDK: iphoneos$IOS_SDK"
            SDK_ARG="-sdk iphoneos$IOS_SDK"
          fi
          
          echo "üî® –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          
          # –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏–º—É–ª—è—Ç–æ—Ä SDK, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —Ç–æ—á–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω
          SIM_SDK=$(xcodebuild -showsdks | grep -o 'iphonesimulator[0-9.]*' | head -n 1 | sed 's/iphonesimulator//' || echo "")
          if [ -n "$SIM_SDK" ]; then
            echo "‚ö†Ô∏è iOS SDK –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–º—É–ª—è—Ç–æ—Ä SDK: iphonesimulator$SIM_SDK"
            SDK_ARG="-sdk iphonesimulator$SIM_SDK"
          fi
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º build –±–µ–∑ destination - —ç—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
          echo "–ü—Ä–æ–±—É–µ–º —Å–±–æ—Ä–∫—É –±–µ–∑ destination..."
          if ! xcodebuild build \
            -workspace ios/M10Wallet.xcworkspace \
            -scheme M10Wallet \
            -configuration Release \
            $SDK_ARG \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CONFIGURATION_BUILD_DIR="${{ github.workspace }}/build" \
            -derivedDataPath "${{ github.workspace }}/build/DerivedData" 2>&1; then
            echo "‚ö†Ô∏è –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ–±—É–µ–º —Å —Å–∏–º—É–ª—è—Ç–æ—Ä–æ–º destination..."
            # –ü—Ä–æ–±—É–µ–º —Å —Å–∏–º—É–ª—è—Ç–æ—Ä–æ–º destination
            xcodebuild build \
              -workspace ios/M10Wallet.xcworkspace \
              -scheme M10Wallet \
              -configuration Release \
              -sdk iphonesimulator \
              -destination "generic/platform=iOS Simulator" \
              CODE_SIGN_IDENTITY="-" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              CONFIGURATION_BUILD_DIR="${{ github.workspace }}/build" \
              -derivedDataPath "${{ github.workspace }}/build/DerivedData"
          fi
          
          # –ò—â–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π .app —Ñ–∞–π–ª –≤ —Ä–∞–∑–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
          APP_PATH=""
          POSSIBLE_PATHS=(
            "${{ github.workspace }}/build/M10Wallet.app"
            "${{ github.workspace }}/build/Release-iphoneos/M10Wallet.app"
            "${{ github.workspace }}/build/Release-iphonesimulator/M10Wallet.app"
            "${{ github.workspace }}/build/DerivedData/Build/Products/Release-iphoneos/M10Wallet.app"
            "${{ github.workspace }}/build/DerivedData/Build/Products/Release-iphonesimulator/M10Wallet.app"
            "ios/build/Release-iphoneos/M10Wallet.app"
            "ios/build/Release-iphonesimulator/M10Wallet.app"
            "ios/build/Build/Products/Release-iphoneos/M10Wallet.app"
            "ios/build/Build/Products/Release-iphonesimulator/M10Wallet.app"
          )
          
          for path in "${POSSIBLE_PATHS[@]}"; do
            if [ -d "$path" ]; then
              APP_PATH="$path"
              echo "‚úÖ –ù–∞–π–¥–µ–Ω .app —Ñ–∞–π–ª: $APP_PATH"
              break
            fi
          done
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå .app —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω! –ò—â–µ–º –≤—Ä—É—á–Ω—É—é..."
            find . -name "M10Wallet.app" -type d 2>/dev/null | head -5
            echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ build –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
            ls -la ${{ github.workspace }}/build/ || true
            ls -la ios/build/ 2>/dev/null || true
            exit 1
          fi
          
          # –ö–æ–ø–∏—Ä—É–µ–º .app –≤ —É–¥–æ–±–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è IPA
          mkdir -p ${{ github.workspace }}/build/app
          cp -r "$APP_PATH" ${{ github.workspace }}/build/app/
          echo "‚úÖ .app —Ñ–∞–π–ª –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è IPA"

      - name: Create IPA
        run: |
          mkdir -p ${{ github.workspace }}/build/ipa
          
          # –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É IPA –¥–ª—è Trollstore
          PAYLOAD_DIR="${{ github.workspace }}/build/ipa/Payload"
          mkdir -p "$PAYLOAD_DIR"
          
          # –ö–æ–ø–∏—Ä—É–µ–º .app —Ñ–∞–π–ª –≤ Payload
          cp -r "${{ github.workspace }}/build/app/M10Wallet.app" "$PAYLOAD_DIR/"
          
          # –°–æ–∑–¥–∞–µ–º IPA —Ñ–∞–π–ª
          cd "${{ github.workspace }}/build/ipa"
          zip -r M10Wallet.ipa Payload
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ IPA —Å–æ–∑–¥–∞–Ω
          if [ ! -f "M10Wallet.ipa" ]; then
            echo "‚ùå IPA —Ñ–∞–π–ª –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω!"
            exit 1
          fi
          
          echo "‚úÖ IPA —Å–æ–∑–¥–∞–Ω: ${{ github.workspace }}/build/ipa/M10Wallet.ipa"
          ls -lh M10Wallet.ipa
          rm -rf Payload

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: M10Wallet-IPA-Xcode
          path: build/ipa/*.ipa
          retention-days: 30

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/ipa/*.ipa
          tag_name: v${{ github.run_number }}-xcode
          name: Release v${{ github.run_number }} (Xcode Build)
          body: |
            IPA —Ñ–∞–π–ª —Å–æ–±—Ä–∞–Ω —á–µ—Ä–µ–∑ Xcode –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ Trollstore
            
            ## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ:
            1. –°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª M10Wallet.ipa
            2. –û—Ç–∫—Ä–æ–π—Ç–µ Trollstore –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
            3. –í—ã–±–µ—Ä–∏—Ç–µ "Install IPA File"
            4. –í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
            5. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

