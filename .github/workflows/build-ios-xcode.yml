name: Build iOS IPA with Xcode

on:
  workflow_dispatch:

jobs:
  build:
    name: Build IPA with Xcode
    runs-on: macos-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest

      - name: Prebuild iOS project
        run: npx expo prebuild --platform ios --clean

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install
          cd ..

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: List available schemes
        run: |
          xcodebuild -list -workspace ios/M10Wallet.xcworkspace || xcodebuild -list -project ios/M10Wallet.xcodeproj

      - name: Build Archive
        run: |
          mkdir -p ${{ github.workspace }}/build
          xcodebuild clean archive \
            -workspace ios/M10Wallet.xcworkspace \
            -scheme M10Wallet \
            -configuration Release \
            -sdk iphoneos \
            -archivePath ${{ github.workspace }}/build/M10Wallet.xcarchive \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            PROVISIONING_PROFILE_SPECIFIER="" \
            -allowProvisioningUpdates || \
          xcodebuild clean archive \
            -workspace ios/M10Wallet.xcworkspace \
            -scheme M10Wallet \
            -configuration Release \
            -sdk iphoneos \
            -archivePath ${{ github.workspace }}/build/M10Wallet.xcarchive \
            -allowProvisioningUpdates

      - name: Export IPA
        run: |
          mkdir -p ${{ github.workspace }}/build/ipa
          # Пробуем экспорт с ad-hoc
          xcodebuild -exportArchive \
            -archivePath ${{ github.workspace }}/build/M10Wallet.xcarchive \
            -exportPath ${{ github.workspace }}/build/ipa \
            -exportOptionsPlist ${{ github.workspace }}/exportOptions.plist \
            -allowProvisioningUpdates || \
          # Если не получилось, пробуем без подписи через альтернативный метод
          (cd ${{ github.workspace }}/build/M10Wallet.xcarchive/Products/Applications && \
           zip -r ${{ github.workspace }}/build/ipa/M10Wallet.ipa M10Wallet.app)

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: M10Wallet-IPA-Xcode
          path: build/ipa/*.ipa
          retention-days: 30

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/ipa/*.ipa
          tag_name: v${{ github.run_number }}-xcode
          name: Release v${{ github.run_number }} (Xcode Build)
          body: |
            IPA файл собран через Xcode для установки через Trollstore
            
            ## Инструкция по установке:
            1. Скачайте файл M10Wallet.ipa
            2. Откройте Trollstore на вашем устройстве
            3. Выберите "Install IPA File"
            4. Выберите скачанный файл
            5. Дождитесь завершения установки
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

