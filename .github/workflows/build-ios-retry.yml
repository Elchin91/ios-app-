name: Build iOS IPA (With Retry)

on:
  workflow_dispatch:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ ÑÐµÑ€Ð²Ð¸ÑÐ°
    - cron: '0 * * * *'

jobs:
  build:
    name: Build IPA with EAS (Retry)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Build IPA
        id: build-step
        continue-on-error: true
        run: |
          echo "Starting EAS build..."
          eas build --platform ios --profile trollstore --non-interactive --no-wait || {
            echo "Build command failed, but continuing to check status..."
            exit 0
          }
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Wait and check build status
        id: build-status
        run: |
          echo "Waiting 15 seconds for build to initialize..."
          sleep 15
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ build
          BUILD_JSON=$(eas build:list --platform ios --limit 1 --json 2>&1)
          
          if echo "$BUILD_JSON" | grep -q "Our services aren't available"; then
            echo "âŒ EAS Build service is currently unavailable"
            echo "Please try again later or check https://status.expo.dev"
            exit 1
          fi
          
          BUILD_ID=$(echo "$BUILD_JSON" | jq -r '.[0].id // empty')
          
          if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "null" ]; then
            echo "âŒ Could not get build ID. Service may be unavailable."
            exit 1
          fi
          
          echo "Build ID: $BUILD_ID"
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_OUTPUT
          
          # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸
          echo "Waiting for build to complete..."
          eas build:wait --id $BUILD_ID --platform ios --timeout 1800 || {
            echo "Build wait timeout or failed"
            BUILD_STATUS=$(eas build:view $BUILD_ID --json | jq -r '.status // "unknown"')
            echo "Final build status: $BUILD_STATUS"
            exit 1
          }
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ URL Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ
          BUILD_INFO=$(eas build:view $BUILD_ID --json)
          BUILD_URL=$(echo "$BUILD_INFO" | jq -r '.artifacts.buildUrl // .artifacts.url // .url // empty')
          
          if [ -z "$BUILD_URL" ] || [ "$BUILD_URL" = "null" ]; then
            BUILD_URL="https://expo.dev/accounts/[your-account]/builds/$BUILD_ID"
          fi
          
          echo "BUILD_URL=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "âœ… Build completed! Download URL: $BUILD_URL"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Output build information
        if: steps.build-status.outputs.BUILD_URL != ''
        run: |
          echo "## ðŸ“± IPA Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build ID: ${{ steps.build-status.outputs.BUILD_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download: ${{ steps.build-status.outputs.BUILD_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation Instructions:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the IPA file from the link above" >> $GITHUB_STEP_SUMMARY
          echo "2. Open Trollstore on your iOS device" >> $GITHUB_STEP_SUMMARY
          echo "3. Select 'Install IPA File'" >> $GITHUB_STEP_SUMMARY
          echo "4. Choose the downloaded M10Wallet.ipa file" >> $GITHUB_STEP_SUMMARY

